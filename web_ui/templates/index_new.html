{% extends "base.html" %}

{% block title %}Dashboard - Code Development Assistant{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Welcome Section -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg shadow-lg text-white p-8">
        <div class="flex items-center">
            <i class="fas fa-code text-4xl mr-4"></i>
            <div>
                <h1 class="text-3xl font-bold mb-2">Code Development Assistant</h1>
                <p class="text-blue-100">Your AI-powered coding companion with Git integration, RAG search, and intelligent code generation.</p>
            </div>
        </div>
    </div>

    <!-- Status Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Git Status -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fab fa-git-alt text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-semibold text-gray-900">Git Repository</h3>
                    <p class="text-gray-600" id="git-status">Loading...</p>
                </div>
            </div>
        </div>

        <!-- RAG Status -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-search text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-semibold text-gray-900">Code Index</h3>
                    <p class="text-gray-600" id="rag-status">Loading...</p>
                </div>
            </div>
        </div>

        <!-- LLM Status -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-robot text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-semibold text-gray-900">AI Model</h3>
                    <p class="text-gray-600" id="llm-status">{{ config.llm.model if config else 'Not configured' }}</p>
                </div>
            </div>
        </div>

        <!-- Workspace -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <i class="fas fa-folder text-xl"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-semibold text-gray-900">Workspace</h3>
                    <p class="text-gray-600 text-sm" title="{{ config.workspace_path if config }}">
                        {{ (config.workspace_path or 'Not set')[-30:] if config else 'Not configured' }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">Quick Actions</h2>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Git Status -->
                <a href="/git" class="group flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="p-2 bg-green-100 text-green-600 rounded-lg group-hover:bg-green-200">
                        <i class="fab fa-git-alt text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-gray-900">Check Git Status</h3>
                        <p class="text-xs text-gray-500">View repository status and manage changes</p>
                    </div>
                </a>

                <!-- Index Codebase -->
                <a href="/rag" class="group flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="p-2 bg-blue-100 text-blue-600 rounded-lg group-hover:bg-blue-200">
                        <i class="fas fa-search text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-gray-900">Index Codebase</h3>
                        <p class="text-xs text-gray-500">Build searchable index of your code</p>
                    </div>
                </a>

                <!-- Generate Code -->
                <a href="/llm" class="group flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="p-2 bg-purple-100 text-purple-600 rounded-lg group-hover:bg-purple-200">
                        <i class="fas fa-magic text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-gray-900">Generate Code</h3>
                        <p class="text-xs text-gray-500">AI-powered code generation</p>
                    </div>
                </a>

                <!-- Chat Assistant -->
                <a href="/chat" class="group flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="p-2 bg-indigo-100 text-indigo-600 rounded-lg group-hover:bg-indigo-200">
                        <i class="fas fa-comments text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-gray-900">Chat Assistant</h3>
                        <p class="text-xs text-gray-500">Ask questions about your code</p>
                    </div>
                </a>

                <!-- View Branches -->
                <button onclick="viewBranches()" class="group flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors w-full text-left">
                    <div class="p-2 bg-green-100 text-green-600 rounded-lg group-hover:bg-green-200">
                        <i class="fas fa-code-branch text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-gray-900">View Branches</h3>
                        <p class="text-xs text-gray-500">See all Git branches</p>
                    </div>
                </button>

                <!-- Settings -->
                <a href="/settings" class="group flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="p-2 bg-gray-100 text-gray-600 rounded-lg group-hover:bg-gray-200">
                        <i class="fas fa-cog text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-gray-900">Settings</h3>
                        <p class="text-xs text-gray-500">Configure assistant settings</p>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="text-xl font-semibold text-gray-900">Recent Activity</h2>
            <button onclick="refreshActivity()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-refresh text-sm"></i>
            </button>
        </div>
        <div class="p-6">
            <div id="recent-activity">
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-clock text-3xl mb-4"></i>
                    <p>Recent activity will appear here</p>
                    <p class="text-sm mt-2">Use the assistant tools to see activity updates</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Workspace Stats -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">Workspace Overview</h2>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="file-count">-</div>
                    <div class="text-sm text-gray-600">Total Files</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="line-count">-</div>
                    <div class="text-sm text-gray-600">Lines of Code</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600" id="commit-count">-</div>
                    <div class="text-sm text-gray-600">Commits</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-yellow-600" id="branch-count">-</div>
                    <div class="text-sm text-gray-600">Branches</div>
                </div>
            </div>
            <div class="mt-4 text-center">
                <button onclick="loadWorkspaceStats()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-md text-sm">
                    <i class="fas fa-sync mr-2"></i>Refresh Stats
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Branch Modal -->
<div id="branchModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden items-center justify-center z-50">
    <div class="relative p-4 w-full max-w-md">
        <div class="bg-white rounded-lg shadow">
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Git Branches</h3>
                <button onclick="closeBranchModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="branchList" class="p-4 max-h-96 overflow-y-auto">
                <!-- Branches will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load status information on page load
document.addEventListener('DOMContentLoaded', function() {
    loadGitStatus();
    loadRagStatus();
    loadWorkspaceStats();
});

async function loadGitStatus() {
    try {
        const response = await fetch('/api/git/status');
        const data = await response.json();
        
        if (data.success) {
            // Extract branch name from status
            const lines = data.output.split('\n');
            const branchLine = lines[0];
            document.getElementById('git-status').textContent = branchLine;
        } else {
            document.getElementById('git-status').textContent = 'No repository';
        }
    } catch (error) {
        document.getElementById('git-status').textContent = 'Error loading';
    }
}

async function loadRagStatus() {
    try {
        const response = await fetch('/api/rag/status');
        const data = await response.json();
        
        if (data.success) {
            // Parse status for indexed files count
            if (data.output.includes('documents')) {
                const match = data.output.match(/(\d+)\s+documents/);
                if (match) {
                    document.getElementById('rag-status').textContent = `${match[1]} documents indexed`;
                } else {
                    document.getElementById('rag-status').textContent = 'Index available';
                }
            } else {
                document.getElementById('rag-status').textContent = 'Not indexed';
            }
        } else {
            document.getElementById('rag-status').textContent = 'Not available';
        }
    } catch (error) {
        document.getElementById('rag-status').textContent = 'Error loading';
    }
}

async function loadWorkspaceStats() {
    // Placeholder for workspace statistics
    // In a real implementation, you'd have API endpoints for these
    document.getElementById('file-count').textContent = '150+';
    document.getElementById('line-count').textContent = '5.2K';
    document.getElementById('commit-count').textContent = '42';
    document.getElementById('branch-count').textContent = '3';
}

async function viewBranches() {
    const modal = document.getElementById('branchModal');
    const branchList = document.getElementById('branchList');
    
    // Show loading
    branchList.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner loading"></i> Loading branches...</div>';
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    try {
        const response = await fetch('/api/git/branches');
        const data = await response.json();
        
        if (data.success) {
            const branches = data.output.split('\n').filter(line => line.trim());
            branchList.innerHTML = branches.map(branch => {
                const isActive = branch.startsWith('*');
                const name = branch.replace(/^\*?\s*/, '');
                return `
                    <div class="flex items-center p-2 rounded ${isActive ? 'bg-blue-50 text-blue-700' : 'hover:bg-gray-50'}">
                        ${isActive ? '<i class="fas fa-arrow-right mr-2"></i>' : '<span class="w-6"></span>'}
                        <span class="font-mono">${name}</span>
                    </div>
                `;
            }).join('');
        } else {
            branchList.innerHTML = '<div class="text-red-600">Error loading branches</div>';
        }
    } catch (error) {
        branchList.innerHTML = '<div class="text-red-600">Error loading branches</div>';
    }
}

function closeBranchModal() {
    const modal = document.getElementById('branchModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

function refreshActivity() {
    showNotification('Activity refreshed!', 'info');
}

// Close modal when clicking outside
document.getElementById('branchModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeBranchModal();
    }
});
</script>
{% endblock %}
