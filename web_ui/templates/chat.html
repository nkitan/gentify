{% extends "base.html" %}

{% block title %}Chat - Code Development Assistant{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                <i class="fas fa-comments text-2xl"></i>
            </div>
            <div class="ml-4">
                <h1 class="text-2xl font-bold text-gray-900">AI Code Assistant Chat</h1>
                <p class="text-gray-600">Have a conversation about your code, ask questions, and get instant help</p>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Chat History -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-lg shadow">
                <!-- Chat Messages -->
                <div id="chat-messages" class="h-96 overflow-y-auto p-6 space-y-4 border-b">
                    <!-- Welcome Message -->
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                                <i class="fas fa-robot text-white text-sm"></i>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="bg-blue-50 rounded-lg p-3">
                                <p class="text-sm text-gray-900">
                                    Hello! I'm your AI code assistant. I can help you with:
                                </p>
                                <ul class="mt-2 text-sm text-gray-700 list-disc list-inside space-y-1">
                                    <li>Explaining complex code</li>
                                    <li>Debugging issues</li>
                                    <li>Code reviews and suggestions</li>
                                    <li>Best practices and patterns</li>
                                    <li>Architecture decisions</li>
                                </ul>
                                <p class="mt-2 text-sm text-gray-600">
                                    Feel free to ask me anything about your code!
                                </p>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">AI Assistant â€¢ just now</div>
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="p-6">
                    <form id="chat-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Question</label>
                            <textarea name="question" rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      placeholder="Ask me anything about your code..."
                                      required></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Code Context (Optional)</label>
                            <textarea name="context" rows="4" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                      placeholder="Paste relevant code here for context..."></textarea>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <button type="button" onclick="clearChat()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-trash mr-1"></i>Clear Chat
                            </button>
                            <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <i class="fas fa-paper-plane mr-2"></i>Send Message
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Quick Actions -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                <div class="space-y-3">
                    <button onclick="insertTemplate('explain')" class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex items-center">
                            <i class="fas fa-lightbulb text-yellow-600 mr-2"></i>
                            <span class="text-sm font-medium">Explain Code</span>
                        </div>
                    </button>
                    
                    <button onclick="insertTemplate('debug')" class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex items-center">
                            <i class="fas fa-bug text-red-600 mr-2"></i>
                            <span class="text-sm font-medium">Debug Issue</span>
                        </div>
                    </button>
                    
                    <button onclick="insertTemplate('review')" class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex items-center">
                            <i class="fas fa-search text-blue-600 mr-2"></i>
                            <span class="text-sm font-medium">Code Review</span>
                        </div>
                    </button>
                    
                    <button onclick="insertTemplate('optimize')" class="w-full text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex items-center">
                            <i class="fas fa-tachometer-alt text-green-600 mr-2"></i>
                            <span class="text-sm font-medium">Optimize Performance</span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Chat Stats -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Session Info</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Messages</span>
                        <span id="message-count" class="text-sm font-medium text-gray-900">1</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Started</span>
                        <span id="session-time" class="text-sm font-medium text-gray-900">just now</span>
                    </div>
                </div>
            </div>

            <!-- Tips -->
            <div class="bg-blue-50 rounded-lg p-4">
                <h4 class="text-sm font-semibold text-blue-900 mb-2">ðŸ’¡ Tips</h4>
                <ul class="text-xs text-blue-800 space-y-1">
                    <li>â€¢ Include code context for better answers</li>
                    <li>â€¢ Be specific about your issues</li>
                    <li>â€¢ Ask about best practices</li>
                    <li>â€¢ Request code examples</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let messageCount = 1;
const sessionStartTime = new Date();

// Update session info
function updateSessionInfo() {
    document.getElementById('message-count').textContent = messageCount;
    
    const now = new Date();
    const diff = Math.floor((now - sessionStartTime) / 1000 / 60); // minutes
    let timeText = 'just now';
    
    if (diff >= 60) {
        timeText = `${Math.floor(diff / 60)}h ${diff % 60}m ago`;
    } else if (diff > 0) {
        timeText = `${diff}m ago`;
    }
    
    document.getElementById('session-time').textContent = timeText;
}

// Update every minute
setInterval(updateSessionInfo, 60000);

// Chat form submission
document.getElementById('chat-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const question = formData.get('question');
    const context = formData.get('context');
    
    if (!question.trim()) return;
    
    // Add user message to chat
    addMessage('user', question, context);
    
    // Clear form
    e.target.reset();
    
    // Show typing indicator
    const typingId = addTypingIndicator();
    
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                question: question,
                context: context
            })
        });
        
        const result = await response.json();
        
        // Remove typing indicator
        removeTypingIndicator(typingId);
        
        if (result.success) {
            addMessage('assistant', result.output);
            showNotification('Response received!', 'success');
        } else {
            addMessage('assistant', 'Sorry, I encountered an error: ' + result.error);
            showNotification('Error: ' + result.error, 'error');
        }
    } catch (error) {
        removeTypingIndicator(typingId);
        addMessage('assistant', 'Sorry, I\'m having trouble connecting. Please try again.');
        showNotification('Failed to send message: ' + error.message, 'error');
    }
});

// Add message to chat
function addMessage(sender, content, context = null) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex items-start space-x-3';
    
    const isUser = sender === 'user';
    const avatar = isUser ? 
        '<div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center"><i class="fas fa-user text-white text-sm"></i></div>' :
        '<div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center"><i class="fas fa-robot text-white text-sm"></i></div>';
    
    const bubbleClass = isUser ? 'bg-gray-100' : 'bg-blue-50';
    const senderName = isUser ? 'You' : 'AI Assistant';
    
    let contextHtml = '';
    if (context && context.trim()) {
        contextHtml = `
            <div class="mt-2 p-2 bg-gray-50 rounded border-l-4 border-gray-300">
                <div class="text-xs font-medium text-gray-600 mb-1">Code Context:</div>
                <pre class="text-xs text-gray-700 whitespace-pre-wrap">${escapeHtml(context)}</pre>
            </div>
        `;
    }
    
    messageDiv.innerHTML = `
        <div class="flex-shrink-0">${avatar}</div>
        <div class="flex-1">
            <div class="${bubbleClass} rounded-lg p-3">
                <div class="text-sm text-gray-900">${formatOutput(content)}</div>
                ${contextHtml}
            </div>
            <div class="text-xs text-gray-500 mt-1">${senderName} â€¢ ${new Date().toLocaleTimeString()}</div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    messageCount++;
    updateSessionInfo();
}

// Add typing indicator
function addTypingIndicator() {
    const chatMessages = document.getElementById('chat-messages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'flex items-start space-x-3 typing-indicator';
    typingDiv.id = 'typing-' + Date.now();
    
    typingDiv.innerHTML = `
        <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                <i class="fas fa-robot text-white text-sm"></i>
            </div>
        </div>
        <div class="flex-1">
            <div class="bg-blue-50 rounded-lg p-3">
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            </div>
            <div class="text-xs text-gray-500 mt-1">AI Assistant â€¢ typing...</div>
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    return typingDiv.id;
}

// Remove typing indicator
function removeTypingIndicator(id) {
    const element = document.getElementById(id);
    if (element) {
        element.remove();
    }
}

// Clear chat
function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.innerHTML = `
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                </div>
                <div class="flex-1">
                    <div class="bg-blue-50 rounded-lg p-3">
                        <p class="text-sm text-gray-900">Chat cleared! How can I help you today?</p>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">AI Assistant â€¢ just now</div>
                </div>
            </div>
        `;
        messageCount = 1;
        updateSessionInfo();
        showNotification('Chat cleared!', 'info');
    }
}

// Insert question templates
function insertTemplate(type) {
    const textarea = document.querySelector('textarea[name="question"]');
    
    const templates = {
        explain: "Can you explain how this code works and what it does?",
        debug: "I'm having an issue with this code. It's not working as expected. Can you help me debug it?",
        review: "Can you review this code and suggest improvements for best practices, performance, and maintainability?",
        optimize: "How can I optimize this code for better performance?"
    };
    
    textarea.value = templates[type] || '';
    textarea.focus();
}

// HTML escape function
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
